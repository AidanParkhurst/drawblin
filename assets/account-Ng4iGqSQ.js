import{i as C,r as B,e as k,b as A,f as E}from"./auth-DsPYn-kI.js";/* empty css              *//* empty css             */import{f as P}from"./entitlements-CMiyezaw.js";const L=(()=>{try{if(typeof window<"u"&&window.DRAWBLIN_API_BASE)return window.DRAWBLIN_API_BASE;const n=location.hostname;return n==="localhost"||n==="127.0.0.1"||n==="::1"?"http://localhost:3000":n==="api.drawbl.in"?"":"https://api.drawbl.in"}catch{return""}})();async function N(n,r){return fetch(`${L}${n}`,r)}function t(n,r={},a=[]){const s=document.createElement(n);for(const[o,l]of Object.entries(r))o==="class"?s.className=l:o==="text"?s.textContent=l:o.startsWith("on")&&typeof l=="function"?s.addEventListener(o.slice(2),l):s.setAttribute(o,l);for(const o of[].concat(a))o&&s.appendChild(typeof o=="string"?document.createTextNode(o):o);return s}async function v(){const n=document.getElementById("account-content");if(!n)return;if(n.innerHTML="",!C()){n.appendChild(t("div",{class:"account-card center"},[t("div",{class:"field-value",text:"Auth not configured."})]));return}await B();const r=A();if(!r){const e=t("button",{class:"btn-primary",text:"Sign in to view account details"});e.addEventListener("click",()=>{window.location.assign("./login")});const i=t("div",{class:"account-card center"},[e]);n.appendChild(i);return}const a=await P(!0)||{};let s="";try{const e=k();if(e){const{data:i,error:c}=await e.from("profiles").select("name").eq("id",r.id).maybeSingle();c||(s=(i?.name||"").trim())}}catch{}const o=t("section",{class:"identity-block"},[t("div",{class:"identity-grid"},[t("div",{},[t("div",{class:"field-label",text:"Goblin Name"}),t("div",{class:"field-value",text:s||"(not set)"})]),t("div",{},[t("div",{class:"field-label",text:"Email"}),t("div",{class:"field-value",text:r.email||"(unknown)"})])])]);let l="Not a premium member",_="";a?.has_premium&&(l="Premium member",_="Renews automatically");let d=null;a?.has_premium&&(d=t("button",{class:"btn-outline",text:"Manage billing"}),d.addEventListener("click",async()=>{d.disabled=!0,d.textContent="Opening portal...";try{const e=E()?.access_token;if(!e)throw new Error("No auth session");const i=await N("/api/subscription/portal",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(i.ok){const c=await i.json();c.url&&(window.location.href=c.url)}else{const c=await i.json().catch(()=>({})),u=[c.detail,c.code].filter(Boolean).join(" | ");alert("Portal error: "+(c.error||i.status)+(u?`
`+u:""))}}catch(e){alert("Portal error: "+(e?.message||e))}finally{d.disabled=!1,d.textContent="Manage billing"}}));const y=t("div",{class:"account-card account-card--row account-row"},[t("div",{},[t("div",{class:"account-row-title",text:l}),t("div",{class:"account-row-sub",text:_})]),d].filter(Boolean)),m=[],f=(e,i)=>{const c=t("div",{class:"account-card account-card--row account-row"},[t("div",{},[t("div",{class:"account-row-title",text:e}),t("div",{class:"account-row-sub",text:i?`Purchased on ${i}`:"Included with Premium"})])]);m.push(c)},x=!!(a?.pet_pack||a?.win_bling_pack||a?.more_goblins_pack);let p={pet_pack:null,win_bling_pack:null,more_goblins_pack:null};if(x)try{const e=k();if(e){const{data:i,error:c}=await e.from("entitlement_events").select("entitlement, created_at").eq("user_id",r.id).eq("kind","grant").in("entitlement",["pet_pack","win_bling_pack","more_goblins_pack"]);if(!c&&Array.isArray(i))for(const u of i){const b=u.entitlement,g=p[b],w=u.created_at?new Date(u.created_at):null;w&&(!g||w<g)&&(p[b]=w)}}}catch{}const h=e=>e instanceof Date?e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"}):null;(a?.pet_pack||a?.has_premium)&&f("Companion Critter Collection",a?.pet_pack?h(p.pet_pack):null),(a?.win_bling_pack||a?.has_premium)&&f("Big Win Bling Bundle",a?.win_bling_pack?h(p.win_bling_pack):null),(a?.more_goblins_pack||a?.has_premium)&&f("More Goblins",a?.more_goblins_pack?h(p.more_goblins_pack):null),m.length||m.push(t("div",{class:"muted",text:"No packs purchased"})),n.appendChild(o),n.appendChild(t("h2",{class:"account-h2",text:"Membership"})),n.appendChild(y),n.appendChild(t("h2",{class:"account-h2",text:"Packs"}));for(const e of m)n.appendChild(e)}window.addEventListener("DOMContentLoaded",v);window.addEventListener("auth:user-changed",v);
