import{i as E,r as j,e as y,b as P,f as C}from"./auth-C3ToxM_q.js";/* empty css              *//* empty css             */import{f as L}from"./entitlements-C9ZtqP9A.js";const N=(()=>{try{if(typeof window<"u"&&window.DRAWBLIN_API_BASE)return window.DRAWBLIN_API_BASE;const a=location.hostname;return a==="localhost"||a==="127.0.0.1"||a==="::1"?"http://localhost:3000":a==="api.drawbl.in"?"":"https://api.drawbl.in"}catch{return""}})();async function x(a,l){return fetch(`${N}${a}`,l)}function e(a,l={},o=[]){const s=document.createElement(a);for(const[c,d]of Object.entries(l))c==="class"?s.className=d:c==="text"?s.textContent=d:c.startsWith("on")&&typeof d=="function"?s.addEventListener(c.slice(2),d):s.setAttribute(c,d);for(const c of[].concat(o))c&&s.appendChild(typeof c=="string"?document.createTextNode(c):c);return s}async function _(){const a=document.getElementById("account-content");if(!a)return;if(a.innerHTML="",!E()){a.appendChild(e("div",{class:"account-card center"},[e("div",{class:"field-value",text:"Auth not configured."})]));return}await j();const l=P();if(!l){const t=e("button",{class:"btn-primary",text:"Sign in to view account details"});t.addEventListener("click",()=>{window.location.assign("./login")});const n=e("div",{class:"account-card center"},[t]);a.appendChild(n);return}const o=await L(!0)||{};let s="";try{const t=y();if(t){const{data:n,error:i}=await t.from("profiles").select("name").eq("id",l.id).maybeSingle();i||(s=(n?.name||"").trim())}}catch{}const c=e("section",{class:"identity-block"},[e("div",{class:"identity-grid"},[e("div",{},[e("div",{class:"field-label",text:"Goblin Name"}),e("div",{class:"field-value",text:s||"(not set)"})]),e("div",{},[e("div",{class:"field-label",text:"Email"}),e("div",{class:"field-value",text:l.email||"(unknown)"})])])]);let d="Not a premium member",g="";o?.has_premium&&(d="Premium member",g="Renews automatically");const u=o?.has_premium?e("button",{class:"btn-outline",text:"Cancel membership"}):null;let p=null;u&&(u.addEventListener("click",async()=>{u.disabled=!0,u.textContent="Cancelling...";try{const t=C()?.access_token;if(!t)throw new Error("No auth session");const n=await x("/api/subscription/cancel",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(n.ok){const i=await n.json();alert("Subscription set to cancel at period end."),await _();return}else{const i=await n.json().catch(()=>({})),r=[i.detail,i.code].filter(Boolean).join(" | ");alert("Cancel failed: "+(i.error||n.status)+(r?`
`+r:""))}}catch(t){alert("Cancel error: "+(t?.message||t))}finally{u.disabled=!1,u.textContent="Cancel membership"}}),p=e("button",{class:"btn-outline",text:"Manage billing"}),p.addEventListener("click",async()=>{p.disabled=!0,p.textContent="Opening portal...";try{const t=C()?.access_token;if(!t)throw new Error("No auth session");const n=await x("/api/subscription/portal",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(n.ok){const i=await n.json();i.url&&(window.location.href=i.url)}else{const i=await n.json().catch(()=>({})),r=[i.detail,i.code].filter(Boolean).join(" | ");alert("Portal error: "+(i.error||n.status)+(r?`
`+r:""))}}catch(t){alert("Portal error: "+(t?.message||t))}finally{p.disabled=!1,p.textContent="Manage billing"}}));const B=e("div",{class:"account-card account-card--row account-row"},[e("div",{},[e("div",{class:"account-row-title",text:d}),e("div",{class:"account-row-sub",text:g})]),u,p].filter(Boolean)),f=[],h=(t,n)=>{const i=e("div",{class:"account-card account-card--row account-row"},[e("div",{},[e("div",{class:"account-row-title",text:t}),e("div",{class:"account-row-sub",text:n?`Purchased on ${n}`:"Included with Premium"})])]);f.push(i)},A=!!(o?.pet_pack||o?.win_bling_pack||o?.more_goblins_pack);let m={pet_pack:null,win_bling_pack:null,more_goblins_pack:null};if(A)try{const t=y();if(t){const{data:n,error:i}=await t.from("entitlement_events").select("entitlement, created_at").eq("user_id",l.id).eq("kind","grant").in("entitlement",["pet_pack","win_bling_pack","more_goblins_pack"]);if(!i&&Array.isArray(n))for(const r of n){const k=r.entitlement,v=m[k],b=r.created_at?new Date(r.created_at):null;b&&(!v||b<v)&&(m[k]=b)}}}catch{}const w=t=>t instanceof Date?t.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"}):null;(o?.pet_pack||o?.has_premium)&&h("Companion Critter Collection",o?.pet_pack?w(m.pet_pack):null),(o?.win_bling_pack||o?.has_premium)&&h("Big Win Bling Bundle",o?.win_bling_pack?w(m.win_bling_pack):null),(o?.more_goblins_pack||o?.has_premium)&&h("More Goblins",o?.more_goblins_pack?w(m.more_goblins_pack):null),f.length||f.push(e("div",{class:"muted",text:"No packs purchased"})),a.appendChild(c),a.appendChild(e("h2",{class:"account-h2",text:"Membership"})),a.appendChild(B),a.appendChild(e("h2",{class:"account-h2",text:"Packs"}));for(const t of f)a.appendChild(t)}window.addEventListener("DOMContentLoaded",_);window.addEventListener("auth:user-changed",_);
